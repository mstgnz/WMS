{% extends 'base.html' %}

{% block content %}

<div class="col-xl-10 col-lg-11 col-md-12">
    <form method="post"> {% csrf_token %}
        <table class="table" style="border:dashed 2px #ccc; background:#fff;">
            <tr style="border-bottom:solid 1px #ddd;">
                <td colspan="7" style="text-align:center; background:#eee;"><b>TAŞERON HAKEDİŞ RAPORU</b></td>
            </tr>
            <tr>
                <td style="width:30px;"></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;"><b>ŞANTİYE</b></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;">{{ form.worksite }}</td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;"><small><b>HAKEDİŞ NO</b></small></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;">{{ form.no }}</td>
                <td style="width:30px;"></td>
            </tr>
            <tr>
                <td></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;"><b>İŞVEREN</b></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;"><input name="employer" value="{{ user.firm }}" readonly /></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;"><small><b>HAKEDİŞ TARİHİ</b></small></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;">{{ form.date }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td colspan="1" style="border-bottom:solid 1px #ddd;"><b>TAŞERON</b></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;"><select name="subcontractor"></select></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>

    <ul id="tab">
        <li>KAPAK</li>
        <li>İCMAL</li>
    </ul>
    <div class="clear"></div>

    <!-- *** HAKEDİŞ SAYFASI *** -->

    <div class="tab_list">
        <table class="table" style="border:dashed 2px #ccc; background:#fff; margin-bottom:100px;">
            <tr style="border-bottom:solid 1px #ddd;">
                <td colspan="7" style="text-align:center; background:#eee;"><b>HAKEDİŞ KAPAK</b></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>A)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">KÜMÜLATİF HAKEDİŞ TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.cumulative }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>B)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">İHZARAT TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.acquisition }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>C)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">İLAVE İŞLER TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.additional }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>D)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">TOPLAM HAKEDİŞ TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>E)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">ÖNCEKİ HAKEDİŞ TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_amount }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>F)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">BU HAKEDİŞ TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_amount }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>G)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">KDV 18%</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.vat }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>H)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">KDV DAHİL HAKEDİŞ TUTARI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.progress_amount }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td colspan="7" style="height:10px; border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;"><b>KESİNTİLER</b></td>
                <td style="border-bottom:solid 1px #ddd;"><b>TOPLAM KESİLEN</b></td>
                <td style="border-bottom:solid 1px #ddd;"><b>ÖNCEKİ KESİLEN</b></td>
                <td style="border-bottom:solid 1px #ddd;"><b>BU HAKEDİŞ KESİLEN</b></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td style="border-bottom:solid 1px #ddd; min-width:200px;">TEMİNAT KESİNTİSİ</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" min="0" max="100" step="1" name="warrant_rate"/></td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_warrant }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_warrant }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_warrant }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td style="width:250px; border-bottom:solid 1px #ddd;">AVANS KESİNTİSİ</td>
                <td style="width:50px; text-align:right; border-bottom:solid 1px #ddd;"><input type="number" min="0" max="100" step="1" name="advance_rate"/></td>
                <td style="width:200px; text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_advance }}</td>
                <td style="width:200px; text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_advance }}</td>
                <td style="width:200px; text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_advance }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td style="border-bottom:solid 1px #ddd;">STOPAJ KESİNTİSİ</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" min="0" max="100" step="1" name="stoppage_rate"/></td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_stoppage }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_stoppage }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_stoppage }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td style="border-bottom:solid 1px #ddd;">KDV TEVFİKATI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" min="0" max="100" step="1" name="tax_cut_rate"/></td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_tax_cut }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_tax_cut }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_tax_cut }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;">CEZA KESİNTİSİ</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_penalty }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_penalty }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_penalty }}</td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;">DİĞER KESİNTİLER</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.total_deduction }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.previous_deduction }}</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.this_deduction }}</td>
                <td></td>
            </tr>
            <tr>
                <td colspan="7" style="height:10px; border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>I)</b></td>
                <td colspan="2" style="border-bottom:solid 1px #ddd;">KESİNTİLER TOPLAMI</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" readonly name="total_deductions"/></td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" readonly name="previous_deductions"/></td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;"><input type="number" readonly name="this_deductions"/></td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td colspan="7" style="height:10px; border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td style="border-bottom:solid 1px #ddd;"><b>J)</b></td>
                <td colspan="4" style="border-bottom:solid 1px #ddd;">ÖDENECEK NET TUTAR</td>
                <td style="text-align:right; border-bottom:solid 1px #ddd;">{{ form.amount_paid }}</td>
                <td style="border-bottom:solid 1px #ddd;"></td>
            </tr>
            <tr>
                <td colspan="7"><button type="submit" class="btn btn-outline-info button"><i class="fas fa-angle-right"></i> {{ title }} <i class="fas fa-angle-left"></i></button></td>
            </tr>
        </table>
    </div>

    <!-- *** İCMAL SAYFASI *** -->

    <div class="tab_list">
        <table class="table" style="border:dashed 2px #ccc; background:#fff; margin-bottom:100px; font-size:12px;">
            <tr style="border-bottom:solid 1px #ddd;">
                <td colspan="10" style="text-align:center; background:#eee; font-size: 15px"><b>HAKEDİŞ İCMAL</b></td>
            </tr>
            <tr>
                <td class="icmal"><b>POZ NO</b></td>
                <td class="icmal"><b>POZ ADI</b></td>
                <td class="icmal"><b>BİRİM</b></td>
                <td class="icmal"><b>BİRİM FİYAT</b></td>
                <td class="icmal"><b>TOPLAM MİKTAR</b></td>
                <td class="icmal"><b>ÖNCEKİ DÖNEM MİKTAR</b></td>
                <td class="icmal"><b>BU DÖNEM MİKTAR</b></td>
                <td class="icmal"><b>TOPLAM TUTAR</b></td>
                <td class="icmal"><b>ÖNCEKİ DÖNEM TUTAR</b></td>
                <td class="icmal"><b>BU DÖNEM TUTAR</b></td>                
            </tr>
            <!-- AJAX İLE BİRİM FİYAT LİSTESİ ÇEKİLİYOR -->
            <tr class="discovery"></tr>
            <tr class="discovery_add"></tr>
            <tr>
                <td colspan="10">
                    <a href="javascript:void(0)" class="append"><i class="fas fa-plus-square fa-lg"></i></a>
                    <a href="javascript:void(0)" class="remove"><i class="fas fa-minus-square fa-lg"></i></a>
                </td>
            </tr>
        </table>
    </div>
    </form>
</div>

{% endblock %}

{% block css %}
<style>
    tr td{
        padding:8px;
    }
    input{
        border:none;
        border-bottom:solid 1px red;
    }
    input:read-only {
        border:none;
    }
    input[type="number"]{
        text-align:right;
    }
    input[name$="rate"]{
        text-align:center;
    }
    .tab_list{
        border:none;
    }
    .icmal{
        border-bottom:solid 1px #ddd;
        border-right:solid 1px #ddd;
    }
    .icmal input[name="pose_no[]"]{
        width: 40px;
    }
    .icmal input[name="name[]"]{
        width: 200px;
    }
    .icmal input[name="unit[]"]{
        width: 30px;
    }
    .icmal input[name="unit_price[]"]{
        width: 75px;
    }
    .icmal input[type="number"]{
        text-align:right;
        width: 75px;
    }
    .append i, .remove i{
        font-size: 25px;
    }
</style>
{% endblock %}

{% block js %}
<script>
    // AJAX
    $('input[type=number]').attr('min',0) // number input minimum değerleri 0 olarak ayarlandı. Eksi değer girilemesin.
    $('input[name=employer]').attr('readonly',true)
    $("select[name=worksite]").change(function(e){
        $('select[name=subcontractor]').empty()
        $('select[name=subcontractor]').append('<option>---------</option>')
        // Şantiye seçim geçişleri temizliği
        $('.discoveries').remove() // Listelenen keşifler temizleniyor
        $('input[value=sub_select]').remove() // taşeron için gizli input temizleniyor.
        $('input[name=no]').val(0) // hakediş no temizleniyor.
        let form_serialize = $('form').serialize()
        $.ajax({
            url: '/progress/add/sub/',
            method: 'POST',
            data: form_serialize,
            type: 'json',
            success: function(result){
                worksite = JSON.parse(result.worksite) // Şantiye
                subcontractor = JSON.parse(result.subcontractor) // Taşeron
                // TAŞERON LİSTESİ
                $.each(subcontractor, function(key, value){
                    $('select[name=subcontractor]').append('<option value="'+value.pk+'">'+value.fields.name+'</option>');
                })
            }
        });
    });

    $("select[name=subcontractor]").change(function(e){
        $('form').append('<input type="hidden" name="type" value="sub_select" />')
        $('.discoveries').remove() // Listelenen keşifler temizleniyor
        $('input[name=no]').val(0) // hakediş no temizleniyor.
        form_serialize = $('form').serialize()
        $.ajax({
            url: '/progress/add/sub/',
            method: 'POST',
            data: form_serialize,
            type: 'json',
            success: function(result){
                progress = JSON.parse(result.progress) // Seçilen şantiyeye ait daha önce eklenmiş hakediş listesi
                discovery = JSON.parse(result.discovery) // Seçilen şantiyeye ait birim fiyat listesi
                synopsis = JSON.parse(result.synopsis) // Seçilen şantiyeye ait birim fiyat listesi
                
                // İCMAL
                if(synopsis.length==0){
                    $.each(discovery, function(key, value){
                        $(`<tr class="discoveries">
                            <td class="icmal"><input type="text" name="pose_no[]" value="${value.fields.no}"></td>
                            <td class="icmal"><input type="text" name="name[]" value="${value.fields.name}"></td>
                            <td class="icmal"><input type="text" name="unit[]" value="${value.fields.unit}"></td>
                            <td class="icmal"><input type="number" name="unit_price[]" value="${value.fields.price}"></td>
                            <td class="icmal"><input type="number" name="total_quantity[]" min=0 step="any" value=0></td>
                            <td class="icmal"><input type="number" name="previous_quantity[]" readonly value=0></td>
                            <td class="icmal"><input type="number" name="this_quantity[]" readonly value=0></td>
                            <td class="icmal"><input type="number" name="total_price[]" readonly value=0></td>
                            <td class="icmal"><input type="number" name="previous_price[]" readonly value=0></td>
                            <td class="icmal"><input type="number" name="this_price[]" readonly value=0></td>
                        </tr>`).insertAfter($('.discovery'))
                    })
                }else{
                    $.each(synopsis, function(key, value){
                        $(`<tr class="discoveries">
                            <td class="icmal"><input type="text" name="pose_no[]" required readonly value="${value.fields.pose_no}"></td>
                            <td class="icmal"><input type="text" name="name[]" required readonly value="${value.fields.name}"></td>
                            <td class="icmal"><input type="text" name="unit[]" required readonly value="${value.fields.unit}"></td>
                            <td class="icmal"><input type="number" name="unit_price[]" required readonly value="${value.fields.unit_price}"></td>
                            <td class="icmal"><input type="number" name="total_quantity[]" min=0 step="any" required value=${value.fields.total_quantity}></td>
                            <td class="icmal"><input type="number" name="previous_quantity[]" required readonly value=${value.fields.total_quantity}></td>
                            <td class="icmal"><input type="number" name="this_quantity[]" required readonly value=0></td>
                            <td class="icmal"><input type="number" name="total_price[]" required readonly value=${value.fields.total_price}></td>
                            <td class="icmal"><input type="number" name="previous_price[]" required readonly value=${value.fields.total_price}></td>
                            <td class="icmal"><input type="number" name="this_price[]" required readonly value=0></td>
                        </tr>`).insertAfter($('.discovery'))
                    })
                }

                // HAKEDİŞ
                $('input[name=no]').val(progress.length ? progress.length+1:1)
                if(progress.length){
                    $('input[name=acquisition]').val(progress[progress.length-1]['fields']['acquisition'])
                    $('input[name=additional]').val(progress[progress.length-1]['fields']['additional'])
                    $('input[name=previous_amount]').val(progress[progress.length-1]['fields']['total'])
                    $('input[name=total_warrant]').val(progress[progress.length-1]['fields']['total_warrant'])
                    $('input[name=total_advance]').val(progress[progress.length-1]['fields']['total_advance'])
                    $('input[name=total_stoppage]').val(progress[progress.length-1]['fields']['total_stoppage'])
                    $('input[name=total_tax_cut]').val(progress[progress.length-1]['fields']['total_tax_cut'])
                    $('input[name=total_penalty]').val(progress[progress.length-1]['fields']['total_penalty'])
                    $('input[name=total_deduction]').val(progress[progress.length-1]['fields']['total_deduction'])
                    $('input[name=previous_warrant]').val(progress[progress.length-1]['fields']['total_warrant'])
                    $('input[name=previous_advance]').val(progress[progress.length-1]['fields']['total_advance'])
                    $('input[name=previous_stoppage]').val(progress[progress.length-1]['fields']['total_stoppage'])
                    $('input[name=previous_tax_cut]').val(progress[progress.length-1]['fields']['total_tax_cut'])
                    $('input[name=previous_penalty]').val(progress[progress.length-1]['fields']['total_penalty'])
                    $('input[name=previous_deduction]').val(progress[progress.length-1]['fields']['total_deduction'])
                    $('input[name=warrant_rate]').val((progress[progress.length-1]['fields']['total_warrant']/progress[progress.length-1]['fields']['total']*100).toFixed(0))
                    $('input[name=advance_rate]').val((progress[progress.length-1]['fields']['total_advance']/progress[progress.length-1]['fields']['total']*100).toFixed(0))
                    
                }else{
                    // Şantiyeler arası geçiş yapılırken formun resetlenmesi gerekmektedir.
                    $('input[name=previous_amount]').val(0)
                    $('input[name=previous_warrant]').val(0)
                    $('input[name=previous_advance]').val(0)
                    $('input[name=previous_stoppage]').val(0)
                    $('input[name=previous_tax_cut]').val(0)
                    $('input[name=previous_penalty]').val(0)
                    $('input[name=previous_deduction]').val(0)
                }
            }
        });
    });
    
    // APPEND MATERIAL
    $('a.append').click(()=>{
        $(`<tr class="discoveries append">
            <td class="icmal"><input type="text" name="pose_no[]" required placeholder="Poz-No"></td>
            <td class="icmal"><input type="text" name="name[]" required placeholder="Poz Adı"></td>
            <td class="icmal"><select name="unit[]"><option value="MT">MT</option><option value="M2">M2</option><option value="M3">M3</option><option value="AD">AD</option><option value="KG">KG</option><option value="TON">TON</option><option value="SET">SET</option></select></td>
            <td class="icmal"><input type="number" name="unit_price[]" min=0 step="any" required value=0></td>
            <td class="icmal"><input type="number" name="total_quantity[]" min=0 step="any" required value=0></td>
            <td class="icmal"><input type="number" name="previous_quantity[]" required readonly value=0></td>
            <td class="icmal"><input type="number" name="this_quantity[]" required readonly value=0></td>
            <td class="icmal"><input type="number" name="total_price[]" required readonly value=0></td>
            <td class="icmal"><input type="number" name="previous_price[]" required readonly value=0></td>
            <td class="icmal"><input type="number" name="this_price[]" required readonly value=0></td>
        </tr>`).insertAfter($('.discovery_add'))
    })

    $('a.remove').click(()=>{
        $('.discoveries.append').last().remove();
    })


    // FORM OTO HESAPLAMA
    $('input[name=warrant_rate]').val(0)
    $('input[name=advance_rate]').val(0)
    $('input[name=stoppage_rate]').val(0)
    $('input[name=tax_cut_rate]').val(0)
    $('form').change(()=>{
        // İCMAL
        unit_price = $("input[name='unit_price[]']").serializeArray()
        total_quantity = $("input[name='total_quantity[]']").serializeArray()
        previous_quantity = $("input[name='previous_quantity[]']").serializeArray()
        $('input[name="this_quantity[]"]').each(function(k,v){
            $(this).val((parseFloat(total_quantity[k].value).toFixed(2)-parseFloat(previous_quantity[k].value).toFixed(2)).toFixed(2))
        })
        $('input[name="total_price[]"]').each(function(k,v){
            $(this).val((parseFloat(unit_price[k].value).toFixed(2)*parseFloat(total_quantity[k].value).toFixed(2)).toFixed(2))
        })
        total_price = $("input[name='total_price[]']").serializeArray()
        previous_price = $("input[name='previous_price[]']").serializeArray()
        $('input[name="this_price[]"]').each(function(k,v){
            $(this).val((parseFloat(total_price[k].value).toFixed(2)-parseFloat(previous_price[k].value).toFixed(2)).toFixed(2))
        })
        // İCMAL TOPLAM HAKEDİŞ KAPAK KÜMÜLATİF TOPLAM
        let total_price_sum = 0;
        for(let i=0; i<total_price.length; i++){
            if(total_price[i].value){
                total_price_sum += parseFloat(total_price[i].value);
            }
        }
        $('input[name=cumulative]').val(total_price_sum.toFixed(2))
        // HAKEDİŞ
        $('input[name=total]').val((
            parseFloat($('input[name=cumulative]').val()) +
            parseFloat($('input[name=acquisition]').val()) +
            parseFloat($('input[name=additional]').val())
        ).toFixed(2))
        $('input[name=this_amount]').val((
            parseFloat($('input[name=total]').val()) -
            parseFloat($('input[name=previous_amount]').val())
        ).toFixed(2))
        $('input[name=progress_amount]').val((
            parseFloat($('input[name=this_amount]').val()) +
            parseFloat($('input[name=vat]').val())
        ).toFixed(2))
        $('input[name=total_warrant]').val((
            parseFloat($('input[name=total]').val()) *
            parseFloat($('input[name=warrant_rate]').val()) / 100
        ).toFixed(2))
        $('input[name=this_warrant]').val((
            parseFloat($('input[name=total_warrant]').val()) -
            parseFloat($('input[name=previous_warrant]').val())
        ).toFixed(2))
        $('input[name=total_advance]').val((
            parseFloat($('input[name=total]').val()) *
            parseFloat($('input[name=advance_rate]').val()) / 100
        ).toFixed(2))
        $('input[name=this_advance]').val((
            parseFloat($('input[name=total_advance]').val()) -
            parseFloat($('input[name=previous_advance]').val())
        ).toFixed(2))
        $('input[name=total_stoppage]').val((
            parseFloat($('input[name=total]').val()) *
            parseFloat($('input[name=stoppage_rate]').val()) / 100
        ).toFixed(2))
        $('input[name=this_stoppage]').val((
            parseFloat($('input[name=total_stoppage]').val()) -
            parseFloat($('input[name=previous_stoppage]').val())
        ).toFixed(2))
        $('input[name=total_tax_cut]').val((
            parseFloat($('input[name=total]').val()*0.18).toFixed(2) *
            parseFloat($('input[name=tax_cut_rate]').val()) / 100
        ).toFixed(2))
        $('input[name=this_tax_cut]').val((
            parseFloat($('input[name=total_tax_cut]').val()) -
            parseFloat($('input[name=previous_tax_cut]').val())
        ).toFixed(2))
        $('input[name=this_penalty]').val((
            parseFloat($('input[name=total_penalty]').val()) -
            parseFloat($('input[name=previous_penalty]').val())
        ).toFixed(2))
        $('input[name=this_deduction]').val((
            parseFloat($('input[name=total_deduction]').val()) -
            parseFloat($('input[name=previous_deduction]').val())
        ).toFixed(2))
        $('input[name=total_deductions]').val((
            parseFloat($('input[name=total_warrant]').val()) +
            parseFloat($('input[name=total_advance]').val()) +
            parseFloat($('input[name=total_stoppage]').val()) +
            parseFloat($('input[name=total_tax_cut]').val()) +
            parseFloat($('input[name=total_penalty]').val()) +
            parseFloat($('input[name=total_deduction]').val())
        ).toFixed(2))
        $('input[name=previous_deductions]').val((
            parseFloat($('input[name=previous_warrant]').val()) +
            parseFloat($('input[name=previous_advance]').val()) +
            parseFloat($('input[name=previous_stoppage]').val()) +
            parseFloat($('input[name=previous_tax_cut]').val()) +
            parseFloat($('input[name=previous_penalty]').val()) +
            parseFloat($('input[name=previous_deduction]').val())
        ).toFixed(2))
        $('input[name=this_deductions]').val((
            parseFloat($('input[name=this_warrant]').val()) +
            parseFloat($('input[name=this_advance]').val()) +
            parseFloat($('input[name=this_stoppage]').val()) +
            parseFloat($('input[name=this_tax_cut]').val()) +
            parseFloat($('input[name=this_penalty]').val()) +
            parseFloat($('input[name=this_deduction]').val())
        ).toFixed(2))
        $('input[name=amount_paid]').val((
            parseFloat($('input[name=progress_amount]').val()) -
            parseFloat($('input[name=this_deductions]').val())
        ).toFixed(2))
    })


</script>
{% endblock %}
